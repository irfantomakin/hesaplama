<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Süre Hesaplama (dk:sn)</title>

<style>
  :root{
    --bg:#f6f7f9;
    --card:#fff;
    --border:#e6e6e6;
    --shadow: 0 6px 16px rgba(0,0,0,.06);
    --danger:#c62828;
    --dark:#2b2b2b;
    --safeTop: env(safe-area-inset-top, 0px);
    --safeBottom: env(safe-area-inset-bottom, 0px);
  }

  html, body { height: 100%; }
  body{
    font-family: Arial, sans-serif;
    margin:0;
    padding: 14px 14px calc(14px + var(--safeBottom));
    max-width: 1100px;
    margin-inline:auto;
    background:var(--bg);
  }

  h1{
    text-align:center;
    margin: calc(6px + var(--safeTop)) 0 12px 0;
    font-size: 20px;
  }

  /* Mobil sekmeler */
  .toolbar{
    display:none;
    gap:10px;
    justify-content:center;
    margin-bottom:10px;
  }
  .btn{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #ddd;
    background:#fff;
    font-weight:700;
    cursor:pointer;
  }
  .btn.active{ border-color:#111; }

  .areas{
    display:flex;
    gap:16px;
    align-items:flex-start;
  }

  .area{
    flex:1;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:14px;
    box-shadow: var(--shadow);
    display:flex;
    flex-direction:column;
    min-height: 0;
  }

  .area-head{
    position: sticky;
    top: 0;
    background: var(--card);
    z-index: 2;
    padding-bottom: 8px;
  }

  .head-row{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
  }

  h2{
    margin: 0 0 4px 0;
    font-size: 18px;
  }

  /* Kırmızı fark alanı (min 60px) */
  .top-diff{
    font-size: 34px;
    font-weight: 900;
    color:var(--danger);
    margin: 4px 0 0 0;
    line-height:1.05;

    min-height: 60px;
    display:flex;
    align-items:center;
  }

  .head-actions{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap: wrap;
    justify-content:flex-end;
  }

  .action-btn{
    border: 1px solid #ddd;
    background: #fff;
    font-weight: 800;
    border-radius: 12px;
    padding: 10px 12px;
    white-space: nowrap;
    cursor: pointer;
  }
  .action-btn:active{ transform: scale(0.98); }

  .clear-all{
    border-color:#f1b7b7;
    color: var(--danger);
  }

  .undo-btn[disabled], .redo-btn[disabled]{
    opacity:.45;
    cursor:not-allowed;
  }

  .list{
    min-height: 0;
    overflow: auto;
    border-top: 1px dashed #f0f0f0;
    border-bottom: 1px dashed #f0f0f0;
    padding: 6px 0;
  }

  .row{
    display:flex;
    align-items:center;
    gap:10px;
    padding:6px 4px;
    border-bottom: 1px dashed #eee;
  }
  .row:last-child{ border-bottom:none; }

  .idx{
    width: 34px;
    text-align:right;
    color:#666;
    font-weight:700;
    flex: 0 0 auto;
  }

  input{
    width: 120px;
    padding:10px;
    text-align:center;
    font-size: 18px;
    border-radius: 14px;
    border:1px solid #dcdcdc;
    outline:none;
    background:#fff;
    color:#111;
  }
  input:focus{
    border-color:#111;
    box-shadow: 0 0 0 4px rgba(0,0,0,.06);
  }

  input.filled{
    background:var(--dark);
    color:#ffffff;
    border-color:var(--dark);
  }
  input.filled::selection{
    background:#ffffff;
    color:#000000;
  }

  .clear-one{
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 18px;
    font-weight: 900;
    line-height: 1;
    cursor: pointer;
    flex: 0 0 auto;
  }
  .clear-one:active{ transform: scale(0.97); }

  .area-foot{
    position: sticky;
    bottom: 0;
    background: var(--card);
    z-index: 2;
    padding-top: 10px;
  }

  .total{
    font-weight:800;
    font-size: 18px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding-top: 10px;
    border-top: 1px solid #eee;
  }

  .subtract-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top:10px;
  }

  .sub-right{
    display:flex;
    gap:10px;
    align-items:center;
    flex: 0 0 auto;
  }

  .grand{
    margin-top: 12px;
    background:#111;
    color:#fff;
    border-radius: 18px;
    padding: 12px 14px;
    text-align:center;
    font-size: 20px;
    font-weight:900;
    position: sticky;
    bottom: 0;
    z-index: 3;
  }

  /* Mobil sığdırma */
  @media (max-width: 900px){
    body{ padding: 10px 10px calc(10px + var(--safeBottom)); }
    h1{ font-size: 18px; margin: calc(6px + var(--safeTop)) 0 10px; }

    .toolbar{ display:flex; }
    .areas{ display:block; }

    .area{ display:none; height: calc(100dvh - (138px + var(--safeTop) + var(--safeBottom))); }
    .area.active{ display:flex; }

    input{ width: 100%; font-size: 18px; padding: 10px; }
    .row{ padding: 6px 2px; }
    .idx{ width: 30px; font-size: 13px; }
    .top-diff{ font-size: 30px; }
    .list{ flex: 1 1 auto; -webkit-overflow-scrolling: touch; }

    .sub-right{ width: 100%; }
  }
</style>
</head>

<body>

<h1>Süre Hesaplama (dk:sn)</h1>

<div class="toolbar">
  <button class="btn active" id="tab1" type="button">Alan 1</button>
  <button class="btn" id="tab2" type="button">Alan 2</button>
</div>

<div class="areas">

  <!-- ALAN 1 -->
  <div class="area active" data-area="1">
    <div class="area-head">
      <div class="head-row">
        <div>
          <h2>Alan 1</h2>
          <div class="top-diff" id="remain1">-00:00</div>
        </div>
        <div class="head-actions">
          <button class="action-btn undo-btn" id="undoBtn1" type="button" disabled>Geri Al</button>
          <button class="action-btn redo-btn" id="redoBtn1" type="button" disabled>İleri Al</button>
          <button class="action-btn clear-all" id="clearArea1" type="button">Hepsini Temizle</button>
        </div>
      </div>
    </div>

    <div class="list" id="area1"></div>

    <div class="area-foot">
      <div class="total">
        <span>Toplam</span><span id="total1">00:00</span>
      </div>

      <div class="subtract-row">
        <b>Girilen</b>
        <div class="sub-right">
          <input id="sub1" placeholder="sn/dk" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
          <button class="clear-one" id="clearSub1" type="button" aria-label="Girilen temizle">✕</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ALAN 2 -->
  <div class="area" data-area="2">
    <div class="area-head">
      <div class="head-row">
        <div>
          <h2>Alan 2</h2>
          <div class="top-diff" id="remain2">-00:00</div>
        </div>
        <div class="head-actions">
          <button class="action-btn undo-btn" id="undoBtn2" type="button" disabled>Geri Al</button>
          <button class="action-btn redo-btn" id="redoBtn2" type="button" disabled>İleri Al</button>
          <button class="action-btn clear-all" id="clearArea2" type="button">Hepsini Temizle</button>
        </div>
      </div>
    </div>

    <div class="list" id="area2"></div>

    <div class="area-foot">
      <div class="total">
        <span>Toplam</span><span id="total2">00:00</span>
      </div>

      <div class="subtract-row">
        <b>Girilen</b>
        <div class="sub-right">
          <input id="sub2" placeholder="sn/dk" inputmode="numeric" pattern="[0-9]*" autocomplete="off" spellcheck="false">
          <button class="clear-one" id="clearSub2" type="button" aria-label="Girilen temizle">✕</button>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="grand">
  GENEL TOPLAM: <span id="grandTotal">00:00</span>
</div>

<script>
/* ------------------ GLOBAL ------------------ */
let allInputs = [];

/* ------------------ UNDO / REDO ------------------ */
const undoStack = [];
const redoStack = [];
const MAX_HISTORY = 120;

function getSnapshot(){
  return {
    area1: Array.from(document.querySelectorAll('#area1 input')).map(i => i.value),
    area2: Array.from(document.querySelectorAll('#area2 input')).map(i => i.value),
    sub1: sub1.value,
    sub2: sub2.value,
    activeArea: document.querySelector('.area.active')?.getAttribute('data-area') || "1"
  };
}

function sameSnapshot(a,b){
  if(!a || !b) return false;
  if(a.sub1 !== b.sub1 || a.sub2 !== b.sub2 || a.activeArea !== b.activeArea) return false;
  if(a.area1.length !== b.area1.length || a.area2.length !== b.area2.length) return false;
  for(let i=0;i<a.area1.length;i++) if(a.area1[i] !== b.area1[i]) return false;
  for(let i=0;i<a.area2.length;i++) if(a.area2[i] !== b.area2[i]) return false;
  return true;
}

function pushUndo(){
  const snap = getSnapshot();
  const last = undoStack[undoStack.length - 1];
  if(last && sameSnapshot(last, snap)) return;

  undoStack.push(snap);
  if(undoStack.length > MAX_HISTORY) undoStack.shift();

  // yeni aksiyon => redo temizlenir
  redoStack.length = 0;

  updateUndoRedoButtons();
}

function applySnapshot(snap){
  const a1 = document.querySelectorAll('#area1 input');
  const a2 = document.querySelectorAll('#area2 input');
  a1.forEach((inp, idx) => inp.value = snap.area1[idx] ?? "");
  a2.forEach((inp, idx) => inp.value = snap.area2[idx] ?? "");
  sub1.value = snap.sub1 ?? "";
  sub2.value = snap.sub2 ?? "";
  setActiveArea(parseInt(snap.activeArea || "1", 10));

  document.querySelectorAll("input").forEach(updateFilledState);
  calculateTotals();
}

function undo(){
  if(undoStack.length === 0) return;
  const current = getSnapshot();
  const prev = undoStack.pop();
  redoStack.push(current);
  applySnapshot(prev);
  updateUndoRedoButtons();
}

function redo(){
  if(redoStack.length === 0) return;
  const current = getSnapshot();
  const next = redoStack.pop();
  undoStack.push(current);
  applySnapshot(next);
  updateUndoRedoButtons();
}

function updateUndoRedoButtons(){
  const uDisabled = undoStack.length === 0;
  const rDisabled = redoStack.length === 0;
  undoBtn1.disabled = uDisabled;
  undoBtn2.disabled = uDisabled;
  redoBtn1.disabled = rDisabled;
  redoBtn2.disabled = rDisabled;
}

/* ------------------ FILLED ------------------ */
function updateFilledState(input){
  if(input.value && input.value.trim() !== "") input.classList.add("filled");
  else input.classList.remove("filled");
}

/* ------------------ FORMAT ------------------ */
function sanitize(value){
  value = (value || "").replace(/[^0-9:]/g,"");
  const parts = value.split(":");
  if(parts.length > 2){
    value = parts[0] + ":" + parts.slice(1).join("").replace(/:/g,"");
  }
  return value;
}

function autoFormat(v){
  v = sanitize(v);
  if(!v) return "";

  if(v.includes(":")){
    let [m,s] = v.split(":");
    m = parseInt(m || "0",10) || 0;
    s = parseInt(s || "0",10) || 0;
    m += Math.floor(s/60);
    s = s % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  const d = v.replace(/\D/g,"");
  if(!d) return "";
  if(d.length <= 2) return `0:${d.padStart(2,"0")}`;

  let m = parseInt(d.slice(0,-2),10) || 0;
  let s = parseInt(d.slice(-2),10) || 0;
  m += Math.floor(s/60);
  s = s % 60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function toSeconds(v){
  if(!v) return 0;
  const f = autoFormat(v);
  if(!f.includes(":")) return 0;
  const [m,s] = f.split(":");
  return (parseInt(m,10)||0)*60 + (parseInt(s,10)||0);
}

function fromSeconds(sec){
  const neg = sec < 0;
  sec = Math.abs(sec);
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${neg?"-":""}${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ------------------ NAV (OK TUŞLARI) ------------------ */
function isVisible(el){ return !!(el.offsetParent); }

function focusPrevVisible(cur){
  const i = allInputs.indexOf(cur);
  for(let j=i-1;j>=0;j--){
    if(isVisible(allInputs[j])){ allInputs[j].focus(); return true; }
  }
  return false;
}
function focusNextVisible(cur){
  const i = allInputs.indexOf(cur);
  for(let j=i+1;j<allInputs.length;j++){
    if(isVisible(allInputs[j])){ allInputs[j].focus(); return true; }
  }
  return false;
}

/* ------------------ INPUT ÜRETİM ------------------ */
function createAreaInputs(containerId, count){
  const c = document.getElementById(containerId);
  for(let i=1;i<=count;i++){
    const row = document.createElement("div");
    row.className = "row";

    const idx = document.createElement("div");
    idx.className = "idx";
    idx.textContent = i + ".";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "sn/dk";
    input.inputMode = "numeric";
    input.pattern = "[0-9]*";
    input.autocomplete = "off";
    input.spellcheck = false;

    const clearBtn = document.createElement("button");
    clearBtn.className = "clear-one";
    clearBtn.type = "button";
    clearBtn.textContent = "✕";
    clearBtn.setAttribute("aria-label", "Satırı temizle");

    wireAreaInput(input);

    clearBtn.addEventListener("click", () => {
      if(!input.value) return;
      pushUndo();
      input.value = "";
      updateFilledState(input);
      calculateTotals();
      input.focus();
    });

    row.appendChild(idx);
    row.appendChild(input);
    row.appendChild(clearBtn);
    c.appendChild(row);

    allInputs.push(input);
  }
}

/* ------------------ SAHA KUTULARI ------------------ */
function wireAreaInput(input){
  input.addEventListener("focus",()=>setTimeout(()=>input.select(),0));
  input.addEventListener("click",()=>setTimeout(()=>input.select(),0));

  input.addEventListener("keydown",(e)=>{
    if(e.key === "ArrowUp" || e.key === "ArrowLeft"){
      e.preventDefault(); focusPrevVisible(input); return;
    }
    if(e.key === "ArrowDown" || e.key === "ArrowRight"){
      e.preventDefault(); focusNextVisible(input); return;
    }
    if(e.key==="Enter"){
      e.preventDefault();
      pushUndo();
      input.value = autoFormat(input.value);
      calculateTotals();
      updateFilledState(input);
      focusNextVisible(input);
    }
  });

  input.addEventListener("input",()=>{
    input.value = sanitize(input.value);

    // 3 hane → format + alt kutu
    if(!input.value.includes(":")){
      const digits = input.value.replace(/\D/g,"");
      if(digits.length === 3){
        pushUndo();
        input.value = autoFormat(digits);
        calculateTotals();
        updateFilledState(input);
        focusNextVisible(input);
        return;
      }
    }

    calculateTotals();
    updateFilledState(input);
  });

  input.addEventListener("blur",()=>{
    if(input.value){
      pushUndo();
      input.value = autoFormat(input.value);
    }
    calculateTotals();
    updateFilledState(input);
  });
}

/* ------------------ GİRİLEN KUTULARI ------------------ */
function wireSubtractInput(input){
  input.addEventListener("focus",()=>setTimeout(()=>input.select(),0));
  input.addEventListener("click",()=>setTimeout(()=>input.select(),0));

  input.addEventListener("keydown",(e)=>{
    if(e.key === "ArrowUp" || e.key === "ArrowLeft"){
      e.preventDefault(); focusPrevVisible(input); return;
    }
    if(e.key === "ArrowDown" || e.key === "ArrowRight"){
      e.preventDefault(); focusNextVisible(input); return;
    }
    if(e.key==="Enter"){
      e.preventDefault();
      pushUndo();
      input.value = autoFormat(input.value);
      calculateTotals();
      updateFilledState(input);
    }
  });

  input.addEventListener("input",()=>{
    input.value = sanitize(input.value);

    // 4 hane → format (kutuda kal)
    if(!input.value.includes(":")){
      const digits = input.value.replace(/\D/g,"");
      if(digits.length === 4){
        pushUndo();
        input.value = autoFormat(digits);
      }
    }

    calculateTotals();
    updateFilledState(input);
  });

  input.addEventListener("blur",()=>{
    if(input.value){
      pushUndo();
      input.value = autoFormat(input.value);
    }
    calculateTotals();
    updateFilledState(input);
  });
}

/* ------------------ TOPLAMLAR ------------------ */
function sumArea(id){
  let t=0;
  document.querySelectorAll(`#${id} input`).forEach(i=> t += toSeconds(i.value));
  return t;
}

function calculateTotals(){
  const a1 = sumArea("area1");
  const a2 = sumArea("area2");

  total1.textContent = fromSeconds(a1);
  total2.textContent = fromSeconds(a2);
  grandTotal.textContent = fromSeconds(a1+a2);

  remain1.textContent = fromSeconds(a1 - toSeconds(sub1.value));
  remain2.textContent = fromSeconds(a2 - toSeconds(sub2.value));
}

/* ------------------ MOBİL SEKME ------------------ */
function setActiveArea(n){
  document.querySelectorAll(".area").forEach(a=>a.classList.remove("active"));
  document.querySelector(`.area[data-area="${n}"]`).classList.add("active");
  tab1.classList.toggle("active",n===1);
  tab2.classList.toggle("active",n===2);
}
tab1.onclick=()=>setActiveArea(1);
tab2.onclick=()=>setActiveArea(2);

/* ------------------ CLEAR BUTONLARI ------------------ */
function clearArea(areaId){
  const inputs = document.querySelectorAll(`#${areaId} input`);
  const anyFilled = Array.from(inputs).some(i => i.value);
  if(!anyFilled) return;

  pushUndo();
  inputs.forEach(i=>{
    i.value = "";
    updateFilledState(i);
  });
  calculateTotals();
}

clearArea1.onclick = ()=> clearArea("area1");
clearArea2.onclick = ()=> clearArea("area2");

// Girilen tek tek temizle (Hepsini Temizle bunları silmez)
clearSub1.onclick = ()=>{
  if(!sub1.value) return;
  pushUndo();
  sub1.value = "";
  updateFilledState(sub1);
  calculateTotals();
  sub1.focus();
};
clearSub2.onclick = ()=>{
  if(!sub2.value) return;
  pushUndo();
  sub2.value = "";
  updateFilledState(sub2);
  calculateTotals();
  sub2.focus();
};

/* ------------------ UNDO/REDO BUTTONS & SHORTCUTS ------------------ */
undoBtn1.onclick = undo;
undoBtn2.onclick = undo;
redoBtn1.onclick = redo;
redoBtn2.onclick = redo;

document.addEventListener("keydown",(e)=>{
  const key = e.key.toLowerCase();
  const mod = e.ctrlKey || e.metaKey;

  if(mod && key === "z" && !e.shiftKey){
    e.preventDefault(); undo(); return;
  }
  if(mod && key === "z" && e.shiftKey){
    e.preventDefault(); redo(); return;
  }
  if(mod && key === "y"){
    e.preventDefault(); redo(); return;
  }
});

/* ------------------ BAŞLAT ------------------ */
createAreaInputs("area1",15);
createAreaInputs("area2",10);

allInputs.push(sub1);
allInputs.push(sub2);

wireSubtractInput(sub1);
wireSubtractInput(sub2);

setActiveArea(1);
calculateTotals();
document.querySelectorAll("input").forEach(updateFilledState);
updateUndoRedoButtons();
</script>

</body>
</html>